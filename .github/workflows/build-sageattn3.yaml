name: Build and Pre-release SageAttention3

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-sageattn3.yaml"
      - "sageattention3_blackwell/**"

permissions:
  contents: write

jobs:
  build-wheel-linux:
    runs-on: ubuntu-latest
    env:
      PYTHON_BUILDER_VERSION: "3.13"
      CUDA_VERSION_MAP: >-
        {
          "cu128": "12.8.1",
          "cu129": "12.9.1",
          "cu130": "13.0.2"
        }
    strategy:
      matrix:
        include:
          # torch2.7+cu128
          - torch: "2.7"
            cuda: "cu128"
          # torch2.8+cu129
          - torch: "2.8"
            cuda: "cu129"
          # torch2.9+cu130
          - torch: "2.9"
            cuda: "cu130"
    steps:
      - name: Maximize build disk space
        uses: easimon/maximize-build-space@master
        with:
          overprovision-lvm: "true"
          remove-android: "true"
          remove-dotnet: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_BUILDER_VERSION }}

      - uses: Jimver/cuda-toolkit@master
        id: cuda-toolkit
        with:
          cuda: ${{ fromJSON(env.CUDA_VERSION_MAP)[matrix.cuda] }}
          log-file-suffix: sageattn3-torch${{ matrix.torch }}-${{ matrix.cuda }}

      - name: Check current PyTorch version
        id: check-torch-version
        run: |
          echo "Fetching PyTorch latest stable release..."
          LATEST_STABLE=$(curl -s https://api.github.com/repos/pytorch/pytorch/releases/latest | grep '"tag_name"' | sed -E 's/.*"v?([0-9]+\.[0-9]+\.[0-9]+)".*/\1/')
          if [ -z "$LATEST_STABLE" ]; then
            echo "Failed to fetch latest stable version, falling back to checking PyPI"
            LATEST_STABLE=$(curl -s https://pypi.org/pypi/torch/json | grep -o '"version":"[0-9]\+\.[0-9]\+\.[0-9]\+"' | head -1 | sed 's/"version":"\([^"]*\)"/\1/')
          fi
          echo "Latest stable PyTorch version: $LATEST_STABLE"
          echo "PYTORCH_LATEST_STABLE=$LATEST_STABLE" >> $GITHUB_ENV

      - name: Set environment variables
        id: set-env
        run: |
          echo "Reading version from setup.py"
          PACKAGE_VERSION=$(grep -E "^\s*version\s*=\s*['\"][^'\"]*['\"]" setup.py | sed -E "s/.*version\s*=\s*['\"]([^'\"]*)['\"].*/\1/")
          echo "Package version: $PACKAGE_VERSION"
          echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV

          if [ -n "${{ env.PYTORCH_LATEST_STABLE }}" ]; then
            PYTORCH_LATEST_MAJOR=$(echo ${{ env.PYTORCH_LATEST_STABLE }} | cut -d. -f1)
            PYTORCH_LATEST_MINOR=$(echo ${{ env.PYTORCH_LATEST_STABLE }} | cut -d. -f2)
            PYTORCH_MATRIX_MAJOR=$(echo ${{ matrix.torch }} | cut -d. -f1)
            PYTORCH_MATRIX_MINOR=$(echo ${{ matrix.torch }} | cut -d. -f2)

            if [ "$PYTORCH_MATRIX_MAJOR" -gt "$PYTORCH_LATEST_MAJOR" ] || ([ "$PYTORCH_MATRIX_MAJOR" -eq "$PYTORCH_LATEST_MAJOR" ] && [ "$PYTORCH_MATRIX_MINOR" -gt "$PYTORCH_LATEST_MINOR" ]); then
              echo "PyTorch ${{ matrix.torch }} is newer than stable version $PYTORCH_LATEST_MAJOR.$PYTORCH_LATEST_MINOR, will use nightly"
              echo "PYTORCH_NIGHTLY=true" >> $GITHUB_ENV
              echo "PYTORCH_INDEX_URL=https://download.pytorch.org/whl/nightly/${{ matrix.cuda }}" >> $GITHUB_ENV
            else
              echo "PyTorch ${{ matrix.torch }} is a stable version"
              echo "PYTORCH_NIGHTLY=false" >> $GITHUB_ENV
              echo "PYTORCH_INDEX_URL=https://download.pytorch.org/whl/${{ matrix.cuda }}" >> $GITHUB_ENV
            fi
          else
            echo "Could not determine latest stable version, assuming ${{ matrix.torch }} is stable"
            echo "PYTORCH_NIGHTLY=false" >> $GITHUB_ENV
            echo "PYTORCH_INDEX_URL=https://download.pytorch.org/whl/${{ matrix.cuda }}" >> $GITHUB_ENV
          fi

          echo "TORCH_CUDA_ARCH_LIST=10.0,12.0" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          rm -rf sageattention3_blackwell/build sageattention3_blackwell/dist
          gcc --version && g++ --version

          if [ "$PYTORCH_NIGHTLY" = "true" ]; then
            echo "Installing PyTorch ${{ matrix.torch }} from nightly channel..."
            python -m pip install --no-cache-dir --pre torch==${{ matrix.torch }}.* torchvision torchaudio triton>=3.0.0 --index-url ${{ env.PYTORCH_INDEX_URL }}
          else
            echo "Installing PyTorch ${{ matrix.torch }} from stable channel..."
            python -m pip install --no-cache-dir torch==${{ matrix.torch }}.* torchvision torchaudio triton>=3.0.0 --index-url ${{ env.PYTORCH_INDEX_URL }}
          fi

          python -m pip install -U build ninja wheel setuptools einops

      - name: Build wheel
        working-directory: sageattention3_blackwell
        env:
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        run: |
          export MAX_JOBS=2
          export CUDA_HOME=$CUDA_PATH
          export LD_LIBRARY_PATH=$CUDA_PATH/lib64:$CUDA_PATH/lib64/stubs:$LD_LIBRARY_PATH
          export LIBRARY_PATH=$CUDA_PATH/lib64:$CUDA_PATH/lib64/stubs:$LIBRARY_PATH
          python -m build --wheel --no-isolation

      - name: Rename wheel with version info
        working-directory: sageattention3_blackwell/dist
        run: |
          for whl in *.whl; do
            prefix="sageattention-${{ env.PACKAGE_VERSION }}"
            suffix="${whl#${prefix}-}"
            new_name="${prefix}+${{ matrix.cuda }}torch${{ matrix.torch }}-${suffix}"

            mv "$whl" "$new_name"
            echo "Renamed: $whl -> $new_name"
          done

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sageattn3-wheel-torch${{ matrix.torch }}-${{ matrix.cuda }}
          path: sageattention3_blackwell/dist/*.whl

  create-pre-release:
    needs: build-wheel-linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get package version
        id: get-version
        run: |
          PACKAGE_VERSION=$(grep -E "^\s*version\s*=\s*['\"][^'\"]*['\"]" setup.py | sed -E "s/.*version\s*=\s*['\"]([^'\"]*)['\"].*/\1/")
          echo "Package version: $PACKAGE_VERSION"
          echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: sageattn3-wheels
          pattern: sageattn3-wheel-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sageattn3-v${{ env.PACKAGE_VERSION }}
          name: SageAttention3 v${{ env.PACKAGE_VERSION }}
          draft: false
          prerelease: true
          files: sageattn3-wheels/*.whl
