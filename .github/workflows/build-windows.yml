name: Build Windows Wheel CUDA 13.0

on:
  workflow_dispatch:
  push:
    branches: [ windows-build ]

jobs:
  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install CUDA 13.0 Toolkit
        shell: powershell
        run: |
          # 安装 CUDA 13.0 (精确匹配 cu130)
          choco install cuda --version=13.0 -y
          Y:\AI\ComfyUI\.venv/Scripts;C:\Program Files\PowerShell\7;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;E:\Program Files\Python314\;E:\Program Files\Python314\Lib;E:\Program Files\Python314\Scripts\;E:\Program Files\Python314\Library\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\160\DTS\Binn\;E:\Microsoft VS Code\bin;Y:\Program Files\Bandizip\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;Y:\Program Files\Bandizip;C:\Users\22214\.cargo\bin;C:\Users\22214\.cargo;C:\Users\22214\.rustup;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit\;C:\Program Files\nodejs\;C:\Program Files\Go\bin;C:\Program Files\Redis\;C:\Windows\dll;Y:\BtSoft\panel\script;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\lib\x64;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\extras\CUPTI\lib64;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;Y:\VMware\VMware Workstation\bin\;C:\Program Files\Common Files\Oracle\Java\javapath;C:\Program Files\Microsoft MPI\Bin\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\dotnet\;C:\Program Files (x86)\cloudflared\;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\150\Tools\Binn\;C:\Program Files (x86)\Microsoft Visual Stu;C:\Program Files\NVIDIA Corporation\NVIDIA app\NvDLISR;Y:\AI\ComfyUI\.venv\Scripts\python.exe;;D:\Program Files\ffmpeg-nonfree\bin;E:\Program Files\MATLAB\R2026a\runtime\win64;E:\Program Files\MATLAB\R2026a\bin;C:\Program Files\PowerShell\7\;C:\Program Files\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\dotnet\;C:\Program Files\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\180\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0\;C:\Program Files\Git\cmd;L:\Program Files\miniconda3\Scripts;L:\Program Files\miniconda3\Library\bin;E:\Program Files\Python314\python.exe;C:\Program Files\Docker\Docker\resources\bin;C:\Users\22214\.cargo\bin;E:\Anaconda3\envs\lmdeploy;E:\Anaconda3\envs\lmdeploy\Library\mingw-w64\bin;E:\Anaconda3\envs\lmdeploy\Library\usr\bin;E:\Anaconda3\envs\lmdeploy\Library\bin;E:\Anaconda3\envs\lmdeploy\Scripts;E:\Anaconda3\envs\lmdeploy\bin;E:\Anaconda3\condabin;Y:\VMware\VMware Workstation\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\lib;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\extras\CUPTI\lib64;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0;C:\WINDOWS\System32\OpenSSH;E:\Microsoft VS Code\bin;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;C:\Program Files\NVIDIA Corporation\NVIDIA NvDLISR;C:\Program Files\dotnetC:\Program Files (x86)\cloudflared;C:\Program Files\Cloudflare\Cloudflare WARP;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0;C:\Program Files\Docker\Docker\resources\bin;C:\Program Files\nodejs;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn;C:\Program Files\Microsoft SQL Server\150\Tools\Binn;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit;C:\Program Files\Git\cmd;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64;C:\Users\22214\scoop\shims;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;.;C:\Users\22214\AppData\Local\Programs\Ollama;Y:\Practical\cpolar;C:\Users\22214\.dotnet\tools;C:\Users\22214\go\bin;C:\Users\22214\.cache\lm-studio\bin;C:\Users\22214\AppData\Roaming\npm;C:\Users\22214\go\bin;C:\Users\22214\.bun\bin;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;E:\AppData\Local\Programs\CodeBuddy CN\bin;E:\Program Files\JetBrains\PyCharm 2025.3\bin;C:\Users\22214\AppData\Local\Python\bin;C:\Users\22214\.dotnet\tools += ";C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\bin"
          Y:\AI\ComfyUI\.venv/Scripts;C:\Program Files\PowerShell\7;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;E:\Program Files\Python314\;E:\Program Files\Python314\Lib;E:\Program Files\Python314\Scripts\;E:\Program Files\Python314\Library\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\160\DTS\Binn\;E:\Microsoft VS Code\bin;Y:\Program Files\Bandizip\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;Y:\Program Files\Bandizip;C:\Users\22214\.cargo\bin;C:\Users\22214\.cargo;C:\Users\22214\.rustup;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit\;C:\Program Files\nodejs\;C:\Program Files\Go\bin;C:\Program Files\Redis\;C:\Windows\dll;Y:\BtSoft\panel\script;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\lib\x64;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\extras\CUPTI\lib64;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;Y:\VMware\VMware Workstation\bin\;C:\Program Files\Common Files\Oracle\Java\javapath;C:\Program Files\Microsoft MPI\Bin\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\dotnet\;C:\Program Files (x86)\cloudflared\;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\150\Tools\Binn\;C:\Program Files (x86)\Microsoft Visual Stu;C:\Program Files\NVIDIA Corporation\NVIDIA app\NvDLISR;Y:\AI\ComfyUI\.venv\Scripts\python.exe;;D:\Program Files\ffmpeg-nonfree\bin;E:\Program Files\MATLAB\R2026a\runtime\win64;E:\Program Files\MATLAB\R2026a\bin;C:\Program Files\PowerShell\7\;C:\Program Files\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\dotnet\;C:\Program Files\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\180\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0\;C:\Program Files\Git\cmd;L:\Program Files\miniconda3\Scripts;L:\Program Files\miniconda3\Library\bin;E:\Program Files\Python314\python.exe;C:\Program Files\Docker\Docker\resources\bin;C:\Users\22214\.cargo\bin;E:\Anaconda3\envs\lmdeploy;E:\Anaconda3\envs\lmdeploy\Library\mingw-w64\bin;E:\Anaconda3\envs\lmdeploy\Library\usr\bin;E:\Anaconda3\envs\lmdeploy\Library\bin;E:\Anaconda3\envs\lmdeploy\Scripts;E:\Anaconda3\envs\lmdeploy\bin;E:\Anaconda3\condabin;Y:\VMware\VMware Workstation\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\lib;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\extras\CUPTI\lib64;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0;C:\WINDOWS\System32\OpenSSH;E:\Microsoft VS Code\bin;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;C:\Program Files\NVIDIA Corporation\NVIDIA NvDLISR;C:\Program Files\dotnetC:\Program Files (x86)\cloudflared;C:\Program Files\Cloudflare\Cloudflare WARP;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0;C:\Program Files\Docker\Docker\resources\bin;C:\Program Files\nodejs;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn;C:\Program Files\Microsoft SQL Server\150\Tools\Binn;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit;C:\Program Files\Git\cmd;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64;C:\Users\22214\scoop\shims;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;.;C:\Users\22214\AppData\Local\Programs\Ollama;Y:\Practical\cpolar;C:\Users\22214\.dotnet\tools;C:\Users\22214\go\bin;C:\Users\22214\.cache\lm-studio\bin;C:\Users\22214\AppData\Roaming\npm;C:\Users\22214\go\bin;C:\Users\22214\.bun\bin;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;E:\AppData\Local\Programs\CodeBuddy CN\bin;E:\Program Files\JetBrains\PyCharm 2025.3\bin;C:\Users\22214\AppData\Local\Python\bin;C:\Users\22214\.dotnet\tools += ";C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\libnvvp"
          echo "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0" >> 
          echo "PATH=Y:\AI\ComfyUI\.venv/Scripts;C:\Program Files\PowerShell\7;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;E:\Program Files\Python314\;E:\Program Files\Python314\Lib;E:\Program Files\Python314\Scripts\;E:\Program Files\Python314\Library\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\160\DTS\Binn\;E:\Microsoft VS Code\bin;Y:\Program Files\Bandizip\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;Y:\Program Files\Bandizip;C:\Users\22214\.cargo\bin;C:\Users\22214\.cargo;C:\Users\22214\.rustup;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit\;C:\Program Files\nodejs\;C:\Program Files\Go\bin;C:\Program Files\Redis\;C:\Windows\dll;Y:\BtSoft\panel\script;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\lib\x64;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\extras\CUPTI\lib64;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;Y:\VMware\VMware Workstation\bin\;C:\Program Files\Common Files\Oracle\Java\javapath;C:\Program Files\Microsoft MPI\Bin\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\dotnet\;C:\Program Files (x86)\cloudflared\;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\150\Tools\Binn\;C:\Program Files (x86)\Microsoft Visual Stu;C:\Program Files\NVIDIA Corporation\NVIDIA app\NvDLISR;Y:\AI\ComfyUI\.venv\Scripts\python.exe;;D:\Program Files\ffmpeg-nonfree\bin;E:\Program Files\MATLAB\R2026a\runtime\win64;E:\Program Files\MATLAB\R2026a\bin;C:\Program Files\PowerShell\7\;C:\Program Files\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\dotnet\;C:\Program Files\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\Tools\Binn\;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\180\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\170\DTS\Binn\;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0\;C:\Program Files\Git\cmd;L:\Program Files\miniconda3\Scripts;L:\Program Files\miniconda3\Library\bin;E:\Program Files\Python314\python.exe;C:\Program Files\Docker\Docker\resources\bin;C:\Users\22214\.cargo\bin;E:\Anaconda3\envs\lmdeploy;E:\Anaconda3\envs\lmdeploy\Library\mingw-w64\bin;E:\Anaconda3\envs\lmdeploy\Library\usr\bin;E:\Anaconda3\envs\lmdeploy\Library\bin;E:\Anaconda3\envs\lmdeploy\Scripts;E:\Anaconda3\envs\lmdeploy\bin;E:\Anaconda3\condabin;Y:\VMware\VMware Workstation\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\bin;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\lib;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\include;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\libnvvp;C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\extras\CUPTI\lib64;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0;C:\WINDOWS\System32\OpenSSH;E:\Microsoft VS Code\bin;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;C:\Program Files\NVIDIA Corporation\NVIDIA NvDLISR;C:\Program Files\dotnetC:\Program Files (x86)\cloudflared;C:\Program Files\Cloudflare\Cloudflare WARP;C:\Program Files\NVIDIA Corporation\Nsight Compute 2025.4.0;C:\Program Files\Docker\Docker\resources\bin;C:\Program Files\nodejs;C:\ProgramData\chocolatey\bin;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn;C:\Program Files\Microsoft SQL Server\150\Tools\Binn;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit;C:\Program Files\Git\cmd;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64;C:\Users\22214\scoop\shims;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;.;C:\Users\22214\AppData\Local\Programs\Ollama;Y:\Practical\cpolar;C:\Users\22214\.dotnet\tools;C:\Users\22214\go\bin;C:\Users\22214\.cache\lm-studio\bin;C:\Users\22214\AppData\Roaming\npm;C:\Users\22214\go\bin;C:\Users\22214\.bun\bin;C:\Users\22214\AppData\Local\Microsoft\WindowsApps;E:\AppData\Local\Programs\CodeBuddy CN\bin;E:\Program Files\JetBrains\PyCharm 2025.3\bin;C:\Users\22214\AppData\Local\Python\bin;C:\Users\22214\.dotnet\tools" >> 
          
      - name: Install CUDA 13.0 compatible PyTorch
        run: |
          # 精确匹配 cu130 的 PyTorch 2.9.1
          pip install torch==2.9.1+cu130 torchvision==0.14.1+cu130 torchaudio==2.9.1 --extra-index-url https://download.pytorch.org/whl/cu130
          pip install wheel==0.43.0 build==1.2.1 setuptools==69.5.1 ninja==1.11.1
          
      - name: Set RTX 40 series architecture
        shell: powershell
        run: |
          # Ada Lovelace 架构 (RTX 40 系列)
          echo "TORCH_CUDA_ARCH_LIST=8.9" >> 
          echo "BUILD_CUDA_EXT=1" >> 
          
      - name: Verify CUDA environment
        run: |
          python -c "import torch; print(f'PyTorch {torch.__version__} + CUDA {torch.version.cuda}')"
          python -c "import torch; print(f'GPU available: {torch.cuda.is_available()}')"
          
      - name: Build wheel
        run: |
          python -m build --wheel --no-isolation .
        env:
          CUDA_HOME: "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sageattention-cu130-windows
          path: dist/*.whl
          retention-days: 7
